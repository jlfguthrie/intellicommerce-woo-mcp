# âœ¨IntelliCommerceâœ¨ Woo MCP - Dependency Management Pipeline
# Made with ğŸ§¡ in Cape Town ğŸ‡¿ğŸ‡¦
# Powered by Xstra AIâœ¨ | Enabled by IntelliCommerceâœ¨

name: ğŸ“¦ Dependency Management

on:
  # Run weekly on Mondays at 9 AM UTC (11 AM in Cape Town)
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of updates to perform'
        required: true
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - major
          - interactive

      create_pr:
        description: 'Create PR for updates'
        required: true
        default: true
        type: boolean

jobs:
  dependency-audit:
    name: ğŸ” Dependency Audit
    runs-on: ubuntu-latest

    outputs:
      has-vulnerabilities: ${{ steps.audit.outputs.has-vulnerabilities }}
      has-updates: ${{ steps.check.outputs.has-updates }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”’ Security audit
        id: audit
        run: |
          if npm audit --audit-level=high; then
            echo "has-vulnerabilities=false" >> $GITHUB_OUTPUT
          else
            echo "has-vulnerabilities=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Check for updates
        id: check
        run: |
          npx npm-check-updates --target minor --jsonUpgraded > updates.json
          if [ -s updates.json ] && [ "$(cat updates.json)" != "{}" ]; then
            echo "has-updates=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Available updates found"
            cat updates.json
          else
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "âœ… All dependencies are up to date"
          fi

      - name: ğŸ“Š Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit
          path: |
            updates.json
            npm-audit.json
        continue-on-error: true

  update-dependencies:
    name: ğŸ“ˆ Update Dependencies
    runs-on: ubuntu-latest
    needs: dependency-audit
    if: needs.dependency-audit.outputs.has-updates == 'true' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install npm-check-updates
        run: npm install -g npm-check-updates

      - name: ğŸ”§ Configure Git
        run: |
          git config user.name "IntelliCommerceâœ¨ Dependency Bot"
          git config user.email "dependencies@intellicommerce.co.za"

      - name: ğŸ“ˆ Update dependencies
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'minor' }}"
          echo "ğŸ”„ Performing $UPDATE_TYPE updates..."

          # Make script executable
          chmod +x scripts/dependencies-update.sh

          # Run dependency update
          ./scripts/dependencies-update.sh $UPDATE_TYPE

      - name: ğŸ§ª Run comprehensive tests
        run: |
          echo "ğŸ§ª Running test suite..."
          npm run test:unit

          echo "ğŸ”¨ Testing build..."
          npm run build

          echo "ğŸ”’ Security check..."
          npm run security:check

          echo "ğŸ“‚ Structure validation..."
          npm run structure:check

      - name: ğŸ“ Generate update summary
        id: summary
        run: |
          echo "## ğŸ“¦ Dependency Updates Summary" > update-summary.md
          echo "**Made with ğŸ§¡ in Cape Town ğŸ‡¿ğŸ‡¦**" >> update-summary.md
          echo "" >> update-summary.md

          if git diff --name-only | grep -q package.json; then
            echo "### ğŸ”„ Updated Packages" >> update-summary.md
            echo "\`\`\`diff" >> update-summary.md
            git diff package.json >> update-summary.md
            echo "\`\`\`" >> update-summary.md
            echo "" >> update-summary.md
          fi

          echo "### âœ… Validation Results" >> update-summary.md
          echo "- ğŸ§ª Tests: Passed" >> update-summary.md
          echo "- ğŸ”¨ Build: Successful" >> update-summary.md
          echo "- ğŸ”’ Security: Clean" >> update-summary.md
          echo "- ğŸ“‚ Structure: Valid" >> update-summary.md
          echo "" >> update-summary.md
          echo "**Powered by Xstra AIâœ¨ | Enabled by IntelliCommerceâœ¨**" >> update-summary.md

          # Set output for PR creation
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”€ Create Pull Request
        if: steps.summary.outputs.changes == 'true' && (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ“¦ chore: Update dependencies (${{ github.event.inputs.update_type || 'minor' }} updates)

            - Automated dependency updates via CI/CD pipeline
            - All tests passing âœ…
            - Security audit clean ğŸ”’

            Made with ğŸ§¡ in Cape Town ğŸ‡¿ğŸ‡¦
          title: "ğŸ“¦ Dependency Updates - ${{ github.event.inputs.update_type || 'Minor' }} Version Bumps"
          body-path: update-summary.md
          branch: feature/dependency-updates-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated
            ğŸ¤– bot

  security-alerts:
    name: ğŸš¨ Security Alert Handler
    runs-on: ubuntu-latest
    needs: dependency-audit
    if: needs.dependency-audit.outputs.has-vulnerabilities == 'true'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”’ Detailed security audit
        run: |
          echo "ğŸš¨ Security vulnerabilities detected!"
          npm audit --audit-level=high
          npm audit fix --dry-run

      - name: ğŸš¨ Create security issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = "ğŸš¨ Security Alert: Vulnerabilities detected in dependencies";
            const body = `
            ## ğŸš¨ Security Alert

            **Automated security scan detected vulnerabilities in project dependencies.**

            **Made with ğŸ§¡ in Cape Town ğŸ‡¿ğŸ‡¦**

            ### ğŸ“‹ Action Required:
            1. Review the security audit results
            2. Update vulnerable packages
            3. Test thoroughly after updates
            4. Run manual security verification

            ### ğŸ”§ Quick Fix Commands:
            \`\`\`bash
            npm audit fix
            npm test
            \`\`\`

            **Powered by Xstra AIâœ¨ | Enabled by IntelliCommerceâœ¨**
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'high-priority', 'ğŸš¨ urgent']
            });
