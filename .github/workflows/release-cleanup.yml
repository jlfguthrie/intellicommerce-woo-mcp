# âœ¨IntelliCommerceâœ¨ Woo MCP - Release Cleanup
# Made with ðŸ§¡ in Cape Town ðŸ‡¿ðŸ‡¦
# Powered by Xstra AIâœ¨ | Enabled by IntelliCommerceâœ¨

name: ðŸ§¹ Release Cleanup

on:
  release:
    types: [published]

jobs:
  cleanup:
    name: ðŸ§¹ Clean up release artifacts
    runs-on: ubuntu-latest
    # Add explicit guards to ensure this only runs on actual release events
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
    - name: ðŸ” Debug Event Context
      run: |
        echo "Event name: ${{ github.event_name }}"
        echo "Event action: ${{ github.event.action }}"
        echo "Release tag: ${{ github.event.release.tag_name || 'N/A' }}"
        echo "This workflow should ONLY run on release.published events"


    - name: ðŸ“‹ Close Release Reminder Issues
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Get the release information
          const releaseTag = context.payload.release.tag_name;
          const releaseUrl = context.payload.release.html_url;

          // Find open release reminder issues
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'release'
          });

          const releaseIssues = issues.data.filter(issue =>
            issue.title.includes('Release') && issue.title.includes('recommended')
          );

          // Close each release reminder issue
          for (const issue of releaseIssues) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ðŸŽ‰ **Release completed!**

The release **${releaseTag}** has been successfully created and published.

ðŸ”— **Release**: ${releaseUrl}
ðŸ“¦ **npm**: https://www.npmjs.com/package/intellicommerce-woo-mcp

This issue is now automatically closed.

---
**Made with ðŸ§¡ in Cape Town ðŸ‡¿ðŸ‡¦**
**Powered by Xstra AIâœ¨ | Enabled by IntelliCommerceâœ¨**`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });

            console.log(`âœ… Closed release reminder issue #${issue.number}`);
          }

          if (releaseIssues.length === 0) {
            console.log('ðŸ“‹ No release reminder issues to close');
          } else {
            console.log(`ðŸ§¹ Closed ${releaseIssues.length} release reminder issue(s)`);
          }

    - name: ðŸ“¢ Release Notification
      run: |
        echo "ðŸŽ‰ IntelliCommerceâœ¨ Woo MCP Release ${{ github.event.release.tag_name }} Published!"
        echo "ðŸ”— Release URL: ${{ github.event.release.html_url }}"
        echo "ðŸ“¦ npm: https://www.npmjs.com/package/intellicommerce-woo-mcp"
        echo ""
        echo "âœ¨ Made with ðŸ§¡ in Cape Town ðŸ‡¿ðŸ‡¦"
        echo "Powered by Xstra AIâœ¨ | Enabled by IntelliCommerceâœ¨"
