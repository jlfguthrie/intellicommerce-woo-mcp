# ✨IntelliCommerce✨ Woo MCP - Release Cleanup
# Made with 🧡 in Cape Town 🇿🇦
# Powered by Xstra AI✨ | Enabled by IntelliCommerce✨

name: 🧹 Release Cleanup

on:
  release:
    types: [published]

jobs:
  cleanup:
    name: 🧹 Clean up release artifacts
    runs-on: ubuntu-latest
    # Add explicit guards to ensure this only runs on actual release events
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
    - name: 🔍 Debug Event Context
      run: |
        echo "Event name: ${{ github.event_name }}"
        echo "Event action: ${{ github.event.action }}"
        echo "Release tag: ${{ github.event.release.tag_name || 'N/A' }}"
        echo "This workflow should ONLY run on release.published events"


    - name: 📋 Close Release Reminder Issues
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          // Get the release information
          const releaseTag = context.payload.release.tag_name;
          const releaseUrl = context.payload.release.html_url;

          // Find open release reminder issues
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'release'
          });

          const releaseIssues = issues.data.filter(issue =>
            issue.title.includes('Release') && issue.title.includes('recommended')
          );

          // Close each release reminder issue
          for (const issue of releaseIssues) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `🎉 **Release completed!**

The release **${releaseTag}** has been successfully created and published.

🔗 **Release**: ${releaseUrl}
📦 **npm**: https://www.npmjs.com/package/intellicommerce-woo-mcp

This issue is now automatically closed.

---
**Made with 🧡 in Cape Town 🇿🇦**
**Powered by Xstra AI✨ | Enabled by IntelliCommerce✨**`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });

            console.log(`✅ Closed release reminder issue #${issue.number}`);
          }

          if (releaseIssues.length === 0) {
            console.log('📋 No release reminder issues to close');
          } else {
            console.log(`🧹 Closed ${releaseIssues.length} release reminder issue(s)`);
          }

    - name: 📢 Release Notification
      run: |
        echo "🎉 IntelliCommerce✨ Woo MCP Release ${{ github.event.release.tag_name }} Published!"
        echo "🔗 Release URL: ${{ github.event.release.html_url }}"
        echo "📦 npm: https://www.npmjs.com/package/intellicommerce-woo-mcp"
        echo ""
        echo "✨ Made with 🧡 in Cape Town 🇿🇦"
        echo "Powered by Xstra AI✨ | Enabled by IntelliCommerce✨"
